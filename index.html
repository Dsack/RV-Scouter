<button onclick="undo()">Undo Last Action</button>
<div id="map" style="height:400px;"></div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
  let map, currentMarker, clickMarker, accuracyCircle;
  let currentLat = null, currentLon = null;

  // Undo stack stores { action: "add"|"delete", layer: marker }
  let undoStack = [];

  function initMap(lat, lon) {
    map = L.map('map').setView([lat, lon], 15);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: 'Â© OpenStreetMap contributors'
    }).addTo(map);

    // Add current location marker
    currentMarker = L.marker([lat, lon]).addTo(map)
      .bindPopup("You are here").openPopup();
    
    // We don't undo GPS marker moves to keep it simple,
    // only manual markers are tracked

    // Add click handler to place draggable marker
    map.on("click", function(e) {
      if (clickMarker) {
        // Removing old clicked marker triggers undo record for delete
        deleteMarker(clickMarker);
      }
      clickMarker = L.marker(e.latlng, { draggable: true }).addTo(map)
        .bindPopup("ðŸ“Œ Clicked Point").openPopup();

      // Track this add
      undoStack.push({ action: 'add', layer: clickMarker });

      // Optional: On drag end, update popup or something else here
    });
  }

  // Deletes a marker with confirmation, pushes delete action to undo stack
  function deleteMarker(marker) {
    if (!confirm("Are you sure you want to delete this marker?")) return;
    map.removeLayer(marker);
    undoStack.push({ action: 'delete', layer: marker });
  }

  // Undo last add or delete
  function undo() {
    if (undoStack.length === 0) {
      alert("Nothing to undo.");
      return;
    }
    const lastAction = undoStack.pop();

    if (lastAction.action === 'add') {
      // Undo add = remove the marker from map
      map.removeLayer(lastAction.layer);
      // If this was clickMarker, clear it
      if (lastAction.layer === clickMarker) {
        clickMarker = null;
      }
    } else if (lastAction.action === 'delete') {
      // Undo delete = add the marker back to map
      lastAction.layer.addTo(map);
      // If it's a clicked marker, reassign clickMarker
      clickMarker = lastAction.layer;
    }
  }

  // Update the GPS location marker; this one is NOT tracked for undo
  function updateCurrentLocation(lat, lon, accuracy) {
    currentLat = lat;
    currentLon = lon;
    if (!map) {
      initMap(lat, lon);
    } else {
      currentMarker.setLatLng([lat, lon]);
      map.setView([lat, lon]);
    }
    if (accuracyCircle) map.removeLayer(accuracyCircle);
    accuracyCircle = L.circle([lat, lon], {
      radius: accuracy,
      color: 'blue',
      fillOpacity: 0.1
    }).addTo(map);
    document.getElementById("status").textContent =
      `Live GPS: Lat ${lat.toFixed(5)}, Lon ${lon.toFixed(5)} (Â±${Math.round(accuracy)}m)`;
  }

  if (navigator.geolocation) {
    navigator.geolocation.watchPosition(
      pos => updateCurrentLocation(pos.coords.latitude, pos.coords.longitude, pos.coords.accuracy),
      err => alert("Error getting location: " + err.message),
      { enableHighAccuracy: true }
    );
  } else {
    alert("Geolocation is not supported by your browser.");
  }
</script>
